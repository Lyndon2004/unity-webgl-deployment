#!/bin/bash

# Unity WebGL éƒ¨ç½²ç®¡ç†ä¸»å‘½ä»¤
# ä½¿ç”¨æ–¹æ³•: unity [start|stop|restart|check|status|logs]

# è·å–è„šæœ¬çš„çœŸå®è·¯å¾„ï¼Œå¤„ç†è½¯é“¾æ¥
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
PROJECT_ROOT="$(cd "$(dirname "$SCRIPT_PATH")/.." && pwd)"
SCRIPTS_DIR="$PROJECT_ROOT/scripts"
LOGS_DIR="$PROJECT_ROOT/logs"
CONFIGS_DIR="$PROJECT_ROOT/configs"

case "$1" in
    start|s)
        echo "ğŸš€ å¯åŠ¨Unity WebGLå®‰å…¨éƒ¨ç½²..."
        bash "$SCRIPTS_DIR/start_secure_unity.sh" "$2"
        ;;
    stop)
        echo "ğŸ›‘ åœæ­¢Unity WebGLæœåŠ¡..."
        if [ -f "$SCRIPTS_DIR/stop_secure_unity.sh" ]; then
            bash "$SCRIPTS_DIR/stop_secure_unity.sh"
        else
            echo "æ­£åœ¨åœæ­¢æœåŠ¡..."
            pkill -f "secure_unity_server.py" 2>/dev/null
            pkill -f "ngrok" 2>/dev/null
            echo "âœ… æœåŠ¡å·²åœæ­¢"
        fi
        ;;
    restart|r)
        echo "ğŸ”„ é‡å¯Unity WebGLæœåŠ¡..."
        if [ -f "$SCRIPTS_DIR/stop_secure_unity.sh" ]; then
            bash "$SCRIPTS_DIR/stop_secure_unity.sh"
        else
            pkill -f "secure_unity_server.py" 2>/dev/null
            pkill -f "ngrok" 2>/dev/null
        fi
        sleep 2
        bash "$SCRIPTS_DIR/start_secure_unity.sh"
        ;;
    upload-help|uh)
        echo "ğŸ“ æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ æŒ‡å—..."
        bash "$SCRIPTS_DIR/upload_helper.sh"
        ;;
    update|u)
        if [ -z "$2" ]; then
            echo "âŒ è¯·æä¾›Unity WebGLæ„å»ºæ–‡ä»¶è·¯å¾„"
            echo "ä½¿ç”¨æ–¹æ³•: unity update /path/to/unity/webgl/build"
            echo ""
            echo "ğŸ’¡ å¦‚éœ€ä¸Šä¼ æ–‡ä»¶æŒ‡å—ï¼Œè¯·æ‰§è¡Œ: unity upload-help"
            exit 1
        fi
        echo "ğŸ”„ æ›´æ–°Unityé¡¹ç›®..."
        bash "$SCRIPTS_DIR/update_unity_build.sh" "$2"
        ;;
    check|status|c)
        echo "ğŸ“Š æ£€æŸ¥Unity WebGLæœåŠ¡çŠ¶æ€..."
        if [ -f "$SCRIPTS_DIR/check_unity_status.sh" ]; then
            bash "$SCRIPTS_DIR/check_unity_status.sh"
        else
            echo "æ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            if pgrep -f "secure_unity_server.py" > /dev/null; then
                echo "âœ… Unityå®‰å…¨æœåŠ¡å™¨: è¿è¡Œä¸­"
            else
                echo "âŒ Unityå®‰å…¨æœåŠ¡å™¨: æœªè¿è¡Œ"
            fi
            if pgrep -f "ngrok" > /dev/null; then
                echo "âœ… ngrokéš§é“: è¿è¡Œä¸­"
            else
                echo "âŒ ngrokéš§é“: æœªè¿è¡Œ"
            fi
        fi
        ;;
    logs|l)
        echo "ğŸ“‹ æŸ¥çœ‹æœåŠ¡æ—¥å¿—..."
        if [ -f "$LOGS_DIR/secure_unity.log" ]; then
            tail -f "$LOGS_DIR/secure_unity.log"
        else
            echo "âŒ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        ;;
    ngrok-logs|nl)
        echo "ğŸ“‹ æŸ¥çœ‹ngrokæ—¥å¿—..."
        if [ -f "$LOGS_DIR/ngrok_secure.log" ]; then
            tail -f "$LOGS_DIR/ngrok_secure.log"
        else
            echo "âŒ ngrokæ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        ;;
    info|i)
        echo "ğŸ“„ æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯..."
        if [ -f "$CONFIGS_DIR/secure_deployment_info.txt" ]; then
            cat "$CONFIGS_DIR/secure_deployment_info.txt"
        else
            echo "âŒ éƒ¨ç½²ä¿¡æ¯æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        ;;
    clean)
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -f /tmp/unity_*.log /tmp/unity_security_config.sh
        rm -rf /home/yuquan/temp/webgl-build 2>/dev/null
        echo "âœ… ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
        ;;
    help|h|*)
        echo "Unity WebGL å®‰å…¨éƒ¨ç½²ç®¡ç†å·¥å…·"
        echo "=============================="
        echo ""
        echo "ä½¿ç”¨æ–¹æ³•: unity <å‘½ä»¤> [é€‰é¡¹]"
        echo ""
        echo "å¯ç”¨å‘½ä»¤:"
        echo "  start, s       å¯åŠ¨å®‰å…¨æœåŠ¡"
        echo "  stop           åœæ­¢æœåŠ¡"
        echo "  restart, r     é‡å¯æœåŠ¡"  
        echo "  upload-help, uh æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ æŒ‡å—"
        echo "  update, u      æ›´æ–°Unityé¡¹ç›®"
        echo "  check, c       æ£€æŸ¥æœåŠ¡çŠ¶æ€"
        echo "  logs, l        æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
        echo "  ngrok-logs, nl æŸ¥çœ‹ngrokæ—¥å¿—"
        echo "  info, i        æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯"
        echo "  clean          æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
        echo "  help, h        æ˜¾ç¤ºæ­¤å¸®åŠ©"
        echo ""
        echo "ç¤ºä¾‹:"
        echo "  unity start              # å¯åŠ¨æœåŠ¡"
        echo "  unity upload-help        # æŸ¥çœ‹æ–‡ä»¶ä¸Šä¼ æŒ‡å—"
        echo "  unity update /home/yuquan/temp/webgl-build  # æ›´æ–°Unityé¡¹ç›®"
        echo "  unity check              # æ£€æŸ¥çŠ¶æ€"
        echo "  unity logs               # æŸ¥çœ‹æ—¥å¿—"
        ;;
esac
